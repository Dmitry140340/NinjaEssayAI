#cloud-config
package_update: true
package_upgrade: true

# –°–ø–∏—Å–æ–∫ –ø–∞–∫–µ—Ç–æ–≤ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
packages:
  - python3
  - python3-pip
  - python3-venv
  - git
  - nginx
  - fail2ban
  - htop
  - curl
  - wget
  - unzip
  - sqlite3
  - certbot
  - python3-certbot-nginx
  - supervisor
  - ufw

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–æ—Ç–∞
users:
  - name: botadmin
    groups: [sudo, www-data]
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCyf2IAn5qcSnKq3RE7wON2uJxulyYuy2bAGdoZkVYM0DprffsMIv/20LgOib3SOTyU2ODcOx63zYBUFWXF7IrVDLL/Ry7KrqQcEVpT+dobMrMDHqFErvV565kWbSJdvxly29/a2v38sg+iBsAGYTR/y4wJSHRVcmRIhhxV1uSnKSTpku3r9KlxSNKlTpqQKc6eNQtLa1tzgx//1Zl1YeyB1HJzZakzNvZsggViiEruf5CrMWA0iZI5CXoT01WfGt+N2psp7ZNTrUhbpi8t5fcdRsYGxNXcpSwH4izZwqHy+X8pHSy0wuvpiDexF02DZQuNur4+rSBgGXP87IdmItzuV6yGOugGcXPqgOBSv6FS5PhlVivVYi0agUTUPIdvbBadqHEqRJ34OmqPiINl457/ItdsGGG8XG6IwrE1BRCyc26sursh3YteP+1Qw4Y760dvZUBHALqNnz3ThhcvHaJYtUczXgRMUjb/BE1KOAeZ7csg4acQe0U+8ErkClP5rc7mHDO9NgJMTA/jv5UoNTO084JKpeeT59rBk59ksabr2CIv50U8q/KeAIhjCay4BZBC5Mpf6nDOfDGyaQ9L/TL3AZCPTDwrlSkbDSF+r1AWmUDtBFD6iCXUgluC74Mo8FlnlH0N2TBqIHmCqRcdV8yVrLl11VCjD3livgQhUFA4CQ== ninjaessayai@timeweb
    # –û—Ç–∫–ª—é—á–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ubuntu –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
users: []

# –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
write_files:
  # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –¥–ª—è Python –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  - path: /etc/sysctl.d/99-bot-optimization.conf
    content: |
      # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è Telegram –±–æ—Ç–∞
      vm.swappiness=10
      vm.dirty_ratio=15
      vm.dirty_background_ratio=5
      net.core.somaxconn=65535
      net.core.netdev_max_backlog=5000
      net.ipv4.ip_local_port_range=1024 65535
      net.ipv4.tcp_fin_timeout=30
      net.ipv4.tcp_keepalive_time=1200
      net.ipv4.tcp_max_syn_backlog=8192
    owner: root:root
    permissions: '0644'

  # Systemd —Å–µ—Ä–≤–∏—Å –¥–ª—è –±–æ—Ç–∞
  - path: /etc/systemd/system/ninjaessayai-bot.service
    content: |
      [Unit]
      Description=NinjaEssayAI Telegram Bot
      After=network.target network-online.target
      Wants=network-online.target
      Requires=network.target

      [Service]
      Type=simple
      User=botadmin
      Group=botadmin
      WorkingDirectory=/opt/ninjaessayai_bot
      Environment=PYTHONPATH=/opt/ninjaessayai_bot
      Environment=PYTHONUNBUFFERED=1
      ExecStart=/opt/ninjaessayai_bot/venv/bin/python bot.py
      ExecReload=/bin/kill -HUP $MAINPID
      Restart=always
      RestartSec=10
      KillMode=mixed
      TimeoutStopSec=30
      StandardOutput=journal
      StandardError=journal
      SyslogIdentifier=ninjaessayai-bot

      # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
      MemoryMax=2G
      MemoryHigh=1.5G
      CPUQuota=150%

      [Install]
      WantedBy=multi-user.target
    owner: root:root
    permissions: '0644'

  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Nginx –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  - path: /etc/nginx/sites-available/bot-status
    content: |
      server {
          listen 80 default_server;
          listen [::]:80 default_server;
          server_name _;
          
          # –ë–∞–∑–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞
          location / {
              return 200 "NinjaEssayAI Bot Server\nStatus: Running\nTime: $time_iso8601\n";
              add_header Content-Type text/plain;
              access_log off;
          }
          
          # Health check endpoint
          location /health {
              access_log off;
              return 200 "OK";
              add_header Content-Type text/plain;
          }
          
          # Status endpoint —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
          location /status {
              access_log off;
              proxy_pass http://127.0.0.1:8080/status;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
          }
          
          # Nginx —Å—Ç–∞—Ç—É—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
          location /nginx-status {
              stub_status on;
              access_log off;
              allow 127.0.0.1;
              deny all;
          }
      }
    owner: root:root
    permissions: '0644'

  # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Fail2Ban –¥–ª—è –∑–∞—â–∏—Ç—ã SSH
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5
      destemail = admin@example.com
      sendername = Fail2Ban
      mta = sendmail

      [sshd]
      enabled = true
      port = 22
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 1800

      [nginx-http-auth]
      enabled = true
      port = http,https
      filter = nginx-http-auth
      logpath = /var/log/nginx/error.log
      maxretry = 5
    owner: root:root
    permissions: '0644'

  # –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –±–æ—Ç–∞
  - path: /opt/deploy-bot.sh
    content: |
      #!/bin/bash
      set -euo pipefail

      # –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
      RED='\033[0;31m'
      GREEN='\033[0;32m'
      YELLOW='\033[1;33m'
      BLUE='\033[0;34m'
      NC='\033[0m'

      echo -e "${GREEN}üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ NinjaEssayAI Bot${NC}"
      echo "=================================================="

      # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
      BOT_DIR="/opt/ninjaessayai_bot"
      REPO_URL="https://github.com/Dmitry140340/NinjaEssayAI.git"
      VENV_PATH="$BOT_DIR/venv"

      # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
      echo -e "${YELLOW}üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π...${NC}"
      mkdir -p "$BOT_DIR"/{logs,data,backups,scripts}
      cd "$BOT_DIR"

      # –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      if [ ! -d ".git" ]; then
          echo -e "${YELLOW}üì• –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...${NC}"
          git clone "$REPO_URL" .
      else
          echo -e "${YELLOW}üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞...${NC}"
          git pull origin main
      fi

      # –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
      if [ ! -d "$VENV_PATH" ]; then
          echo -e "${YELLOW}üêç –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è...${NC}"
          python3 -m venv "$VENV_PATH"
      fi

      # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      echo -e "${YELLOW}üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π...${NC}"
      source "$VENV_PATH/bin/activate"
      pip install --upgrade pip
      pip install -r requirements.txt

      # –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      if [ ! -f ".env" ]; then
          echo -e "${YELLOW}‚öôÔ∏è  –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${NC}"
          cat > .env << 'EOF'
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram Bot
      TELEGRAM_BOT_TOKEN=YOUR_BOT_TOKEN_HERE
      
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ DeepSeek API
      DEEPSEEK_API_KEY=YOUR_DEEPSEEK_API_KEY_HERE
      
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ YooKassa
      YOOKASSA_SHOP_ID=YOUR_SHOP_ID_HERE
      YOOKASSA_SECRET_KEY=YOUR_SECRET_KEY_HERE
      
      # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
      LOG_LEVEL=INFO
      MAX_WORKERS=10
      RATE_LIMIT_REQUESTS=5
      RATE_LIMIT_WINDOW=3600
      EOF
          echo -e "${RED}‚ö†Ô∏è  –í–ê–ñ–ù–û: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª .env —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏!${NC}"
          echo -e "${BLUE}nano $BOT_DIR/.env${NC}"
      fi

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
      echo -e "${YELLOW}üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞...${NC}"
      chown -R botadmin:botadmin "$BOT_DIR"
      chmod +x "$BOT_DIR"/*.py

      # –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
      if [ ! -f "$BOT_DIR/user_activity.db" ]; then
          echo -e "${YELLOW}üóÑÔ∏è  –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...${NC}"
          touch "$BOT_DIR/user_activity.db"
          chown botadmin:botadmin "$BOT_DIR/user_activity.db"
      fi

      echo -e "${GREEN}‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!${NC}"
      echo -e "${BLUE}–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:${NC}"
      echo -e "${BLUE}1. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env: nano $BOT_DIR/.env${NC}"
      echo -e "${BLUE}2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: systemctl start ninjaessayai-bot${NC}"
      echo -e "${BLUE}3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å: systemctl status ninjaessayai-bot${NC}"
    owner: root:root
    permissions: '0755'

  # –°–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–∏—Å—Ç–µ–º—ã
  - path: /opt/monitor-system.sh
    content: |
      #!/bin/bash
      
      echo "üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ NinjaEssayAI Bot Server"
      echo "===================================="
      echo "–í—Ä–µ–º—è: $(date)"
      echo ""
      
      # –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
      echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:"
      if systemctl is-active --quiet ninjaessayai-bot; then
          echo "‚úÖ Bot —Å–µ—Ä–≤–∏—Å: –ó–ê–ü–£–©–ï–ù"
          uptime_seconds=$(systemctl show -p ActiveEnterTimestamp ninjaessayai-bot --value | xargs -I {} date -d {} +%s)
          current_seconds=$(date +%s)
          uptime_duration=$((current_seconds - uptime_seconds))
          uptime_formatted=$(date -d @$uptime_duration -u +%H:%M:%S)
          echo "‚è±Ô∏è  –í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: $uptime_formatted"
      else
          echo "‚ùå Bot —Å–µ—Ä–≤–∏—Å: –û–°–¢–ê–ù–û–í–õ–ï–ù"
      fi
      
      # –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
      echo ""
      echo "üíª –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:"
      echo "CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | awk -F'%' '{print $1}')"
      echo "RAM: $(free -h | awk 'NR==2{printf "%.1f%% (%s/%s)", $3*100/$2, $3, $2}')"
      echo "–î–∏—Å–∫: $(df -h / | awk 'NR==2{printf "%s (%s)", $5, $4}')"
      echo "Load Average: $(uptime | awk -F'load average:' '{print $2}')"
      
      # –°–µ—Ç–µ–≤—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
      echo ""
      echo "üåê –°–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:"
      echo "–ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: $(ss -t | wc -l)"
      echo "–û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã: $(ss -tlnp | grep -E ':(22|80|443)' | wc -l)"
      
      # –õ–æ–≥–∏ –±–æ—Ç–∞
      echo ""
      echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ –±–æ—Ç–∞ (5 —Å—Ç—Ä–æ–∫):"
      journalctl -u ninjaessayai-bot -n 5 --no-pager -q || echo "–õ–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
      
      # –†–∞–∑–º–µ—Ä –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      if [ -f "/opt/ninjaessayai_bot/user_activity.db" ]; then
          echo ""
          echo "üóÑÔ∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:"
          db_size=$(du -h /opt/ninjaessayai_bot/user_activity.db | cut -f1)
          echo "–†–∞–∑–º–µ—Ä –ë–î: $db_size"
      fi
      
      echo ""
      echo "üîó –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
      echo "systemctl status ninjaessayai-bot  # –ü–æ–¥—Ä–æ–±–Ω—ã–π —Å—Ç–∞—Ç—É—Å"
      echo "journalctl -u ninjaessayai-bot -f  # –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
      echo "systemctl restart ninjaessayai-bot # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫"
    owner: root:root
    permissions: '0755'

  # –°–∫—Ä–∏–ø—Ç –±—ç–∫–∞–ø–∞
  - path: /opt/backup-bot.sh
    content: |
      #!/bin/bash
      
      BACKUP_DIR="/opt/ninjaessayai_bot/backups"
      BOT_DIR="/opt/ninjaessayai_bot"
      DATE=$(date +%Y%m%d_%H%M%S)
      
      echo "üîÑ –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ NinjaEssayAI Bot - $DATE"
      
      # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±—ç–∫–∞–ø–∞ –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
      mkdir -p "$BACKUP_DIR"
      
      # –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
      if [ -f "$BOT_DIR/user_activity.db" ]; then
          echo "üìä –ë—ç–∫–∞–ø –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
          cp "$BOT_DIR/user_activity.db" "$BACKUP_DIR/user_activity_$DATE.db"
          echo "‚úÖ –ë–î —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: user_activity_$DATE.db"
      fi
      
      # –ë—ç–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
      if [ -f "$BOT_DIR/.env" ]; then
          echo "‚öôÔ∏è  –ë—ç–∫–∞–ø –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
          tar -czf "$BACKUP_DIR/config_$DATE.tar.gz" -C "$BOT_DIR" .env
          echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω: config_$DATE.tar.gz"
      fi
      
      # –ë—ç–∫–∞–ø –ª–æ–≥–æ–≤
      if [ -d "$BOT_DIR/logs" ]; then
          echo "üìã –ë—ç–∫–∞–ø –ª–æ–≥–æ–≤..."
          tar -czf "$BACKUP_DIR/logs_$DATE.tar.gz" -C "$BOT_DIR" logs/
          echo "‚úÖ –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: logs_$DATE.tar.gz"
      fi
      
      # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
      echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤..."
      find "$BACKUP_DIR" -name "*.db" -mtime +7 -delete
      find "$BACKUP_DIR" -name "*.tar.gz" -mtime +7 -delete
      
      # –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–æ–≤
      echo "üìÅ –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–æ–≤: $(du -sh $BACKUP_DIR | cut -f1)"
      echo "‚úÖ –ë—ç–∫–∞–ø –∑–∞–≤–µ—Ä—à–µ–Ω!"
    owner: root:root
    permissions: '0755'

# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
runcmd:
  # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
  - sysctl -p /etc/sysctl.d/99-bot-optimization.conf

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞
  - timedatectl set-timezone Europe/Moscow

  # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª–∏
  - locale-gen ru_RU.UTF-8
  - update-locale LANG=ru_RU.UTF-8

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UFW (Uncomplicated Firewall)
  - ufw --force enable
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow ssh
  - ufw allow http
  - ufw allow https

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx
  - rm -f /etc/nginx/sites-enabled/default
  - ln -sf /etc/nginx/sites-available/bot-status /etc/nginx/sites-enabled/
  - nginx -t
  - systemctl enable nginx
  - systemctl start nginx

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Fail2Ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –±–æ—Ç–∞
  - useradd -m -s /bin/bash -G sudo,www-data botadmin || true
  - mkdir -p /home/botadmin/.ssh
  - echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCyf2IAn5qcSnKq3RE7wON2uJxulyYuy2bAGdoZkVYM0DprffsMIv/20LgOib3SOTyU2ODcOx63zYBUFWXF7IrVDLL/Ry7KrqQcEVpT+dobMrMDHqFErvV565kWbSJdvxly29/a2v38sg+iBsAGYTR/y4wJSHRVcmRIhhxV1uSnKSTpku3r9KlxSNKlTpqQKc6eNQtLa1tzgx//1Zl1YeyB1HJzZakzNvZsggViiEruf5CrMWA0iZI5CXoT01WfGt+N2psp7ZNTrUhbpi8t5fcdRsYGxNXcpSwH4izZwqHy+X8pHSy0wuvpiDexF02DZQuNur4+rSBgGXP87IdmItzuV6yGOugGcXPqgOBSv6FS5PhlVivVYi0agUTUPIdvbBadqHEqRJ34OmqPiINl457/ItdsGGG8XG6IwrE1BRCyc26sursh3YteP+1Qw4Y760dvZUBHALqNnz3ThhcvHaJYtUczXgRMUjb/BE1KOAeZ7csg4acQe0U+8ErkClP5rc7mHDO9NgJMTA/jv5UoNTO084JKpeeT59rBk59ksabr2CIv50U8q/KeAIhjCay4BZBC5Mpf6nDOfDGyaQ9L/TL3AZCPTDwrlSkbDSF+r1AWmUDtBFD6iCXUgluC74Mo8FlnlH0N2TBqIHmCqRcdV8yVrLl11VCjD3livgQhUFA4CQ== ninjaessayai@timeweb" > /home/botadmin/.ssh/authorized_keys
  - chown -R botadmin:botadmin /home/botadmin/.ssh
  - chmod 700 /home/botadmin/.ssh
  - chmod 600 /home/botadmin/.ssh/authorized_keys

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ sudo –±–µ–∑ –ø–∞—Ä–æ–ª—è –¥–ª—è botadmin
  - echo "botadmin ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/botadmin
  - chmod 440 /etc/sudoers.d/botadmin

  # –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
  - /opt/deploy-bot.sh

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤ (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00)
  - echo "0 3 * * * root /opt/backup-bot.sh >> /var/log/bot-backup.log 2>&1" >> /etc/crontab

  # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤
  - |
    cat > /etc/logrotate.d/ninjaessayai-bot << 'EOF'
    /opt/ninjaessayai_bot/logs/*.log {
        daily
        missingok
        rotate 7
        compress
        delaycompress
        notifempty
        sharedscripts
        postrotate
            systemctl reload ninjaessayai-bot > /dev/null 2>&1 || true
        endscript
    }
    EOF

  # –í–∫–ª—é—á–µ–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞
  - systemctl daemon-reload
  - systemctl enable ninjaessayai-bot

  # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å–∫—Ä–∏–ø—Ç—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
  - ln -sf /opt/monitor-system.sh /usr/local/bin/bot-monitor
  - ln -sf /opt/backup-bot.sh /usr/local/bin/bot-backup
  - ln -sf /opt/deploy-bot.sh /usr/local/bin/bot-deploy

  # –§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤
  - chown -R botadmin:botadmin /opt/ninjaessayai_bot

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
power_state:
  mode: reboot
  timeout: 30
  condition: True

# –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
final_message: |
  ‚úÖ NinjaEssayAI Bot Server —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!
  
  üîß –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
  1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –ø–æ SSH: ssh botadmin@YOUR_SERVER_IP
  2. –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ .env: nano /opt/ninjaessayai_bot/.env
  3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞: sudo systemctl start ninjaessayai-bot
  
  üìä –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
  - bot-monitor     # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã
  - bot-backup      # –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø
  - bot-deploy      # –ü–µ—Ä–µ—Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
  
  üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: http://YOUR_SERVER_IP/health
  üìã –õ–æ–≥–∏: journalctl -u ninjaessayai-bot -f
  
  ‚ö†Ô∏è  –ù–ï –ó–ê–ë–£–î–¨–¢–ï: –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª .env —Å –≤–∞—à–∏–º–∏ —Ç–æ–∫–µ–Ω–∞–º–∏!
