# 🔄 Схема работы кнопки "Назад"

## Визуальная карта навигации

```
┌─────────────────────────────────────────────────────────────────┐
│                         /order (НАЧАЛО)                          │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│  ШАГ 1: WORK_TYPE - Выбор типа работы                          │
│  📝 Эссе | 📜 Доклад | 📖 Реферат | 💼 Проект | и т.д.        │
│                                                                  │
│  Кнопка "Назад": ⚠️  Вы уже на первом шаге                     │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│  ШАГ 2: SCIENCE_NAME - Ввод дисциплины                         │
│  Пример: "Математика", "История", "Физика"                      │
│                                                                  │
│  [◀️ Назад] ──────────────────────────────────────→ ШАГ 1      │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│  ШАГ 3: PAGE_NUMBER - Количество страниц                       │
│  Ввод числа (с учётом лимитов по типу работы)                  │
│                                                                  │
│  [◀️ Назад] ──────────────────────────────────────→ ШАГ 2      │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│  ШАГ 4: WORK_THEME - Тема работы                               │
│  Пример: "Применение математики в экономике"                    │
│                                                                  │
│  [◀️ Назад] ──────────────────────────────────────→ ШАГ 3      │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│  ШАГ 5: CUSTOM_PLAN - Выбор типа плана                         │
│  🤖 Автоматический план  |  ✍️ Создать свой план              │
│                                                                  │
│  [◀️ Назад] ──────────────────────────────────────→ ШАГ 4      │
└────────────────────┬────────────────┬───────────────────────────┘
                     ↓                ↓
          ┌──────────────┐   ┌──────────────────┐
          │ Автоматический│   │ Пользовательский │
          │     план      │   │       план       │
          └──────┬────────┘   └────────┬─────────┘
                 ↓                     ↓
    ┌────────────────────┐  ┌─────────────────────────────┐
    │ Ввод предпочтений │  │ Ввод плана                  │
    │                    │  │ (каждый пункт с новой строки)│
    │ [◀️ Назад] → ШАГ 5│  │                             │
    └────────┬───────────┘  │ [◀️ Назад] → ШАГ 5         │
             ↓               └──────────┬──────────────────┘
             │                          ↓
             │               ┌──────────────────────┐
             │               │ Ввод предпочтений   │
             │               │                      │
             │               │ [◀️ Назад] → ШАГ 5  │
             │               └──────────┬───────────┘
             └───────────────────┬──────┘
                                 ↓
┌─────────────────────────────────────────────────────────────────┐
│  ШАГ 6: PAYMENT - Оплата                                        │
│  💳 Оплатить заказ  |  🧪 Тестовый заказ (если TESTING_MODE)   │
│                                                                  │
│  [◀️ Назад] (inline) ──────────────────────────→ ШАГ 5         │
│                      (с учётом типа плана)                      │
└────────────────────────────┬────────────────────────────────────┘
                             ↓
                    ┌────────────────┐
                    │ ✅ Заказ создан│
                    └────────────────┘
```

## 🔍 Детали поведения кнопки "Назад"

### 1. Обычные этапы (ШАГ 2-5)
- **Тип кнопки:** ReplyKeyboardMarkup (обычная кнопка внизу экрана)
- **Текст:** "◀️ Назад"
- **Поведение:** Возврат на предыдущий шаг
- **Сброс данных:** Данные текущего шага сбрасываются

### 2. Этап оплаты (ШАГ 6)
- **Тип кнопки:** InlineKeyboardButton (кнопка под сообщением)
- **Callback data:** "back"
- **Поведение:** Возврат к PREFERENCES или вводу плана
- **Особенность:** Учитывает, был ли введён пользовательский план

### 3. Первый этап (ШАГ 1)
- **Поведение:** Предупреждение, что уже на первом шаге
- **Альтернатива:** Использовать `/cancel` для отмены

## 🔄 Сброс данных при возврате

При нажатии "Назад" сбрасываются данные **текущего** шага:

| С этапа → На этап | Сбрасываемые данные |
|-------------------|---------------------|
| SCIENCE_NAME → WORK_TYPE | `science_name` |
| PAGE_NUMBER → SCIENCE_NAME | `page_number` |
| WORK_THEME → PAGE_NUMBER | `work_theme` |
| CUSTOM_PLAN → WORK_THEME | `use_custom_plan`, `custom_plan`, `plan_entered` |
| PREFERENCES → CUSTOM_PLAN | `preferences`, `plan_entered`, `custom_plan`, `use_custom_plan` |
| PAYMENT → PREFERENCES | `preferences` |

**Примечание:** Данные предыдущих этапов сохраняются!

## 📱 Пользовательский опыт

### Сценарий 1: Исправление ошибки в дисциплине
```
Пользователь: Выбрал "Эссе" → Ввёл "Математтика" (опечатка)
              ↓
              Нажимает "◀️ Назад"
              ↓
              Возвращается к вводу дисциплины
              ↓
              Вводит "Математика" (правильно)
              ↓
              Продолжает дальше
```

### Сценарий 2: Изменение типа плана
```
Пользователь: Прошёл все шаги → Выбрал "Автоматический план"
              ↓
              Вводит предпочтения
              ↓
              Передумал, хочет свой план
              ↓
              Нажимает "◀️ Назад"
              ↓
              Возвращается к выбору типа плана
              ↓
              Выбирает "Создать свой план"
              ↓
              Вводит план и продолжает
```

### Сценарий 3: Возврат с оплаты
```
Пользователь: Дошёл до оплаты → Увидел сумму
              ↓
              Хочет изменить количество страниц
              ↓
              Нажимает inline-кнопку "◀️ Назад"
              ↓
              Возвращается к предпочтениям
              ↓
              Снова нажимает "◀️ Назад"
              ↓
              Возвращается к выбору типа плана
              ↓
              ... и так далее до нужного шага
```

## 🛠️ Техническая реализация

### Функции обработки возврата:
1. `go_back_handler()` - главный обработчик для текстовых кнопок
2. `back_button_handler()` - обработчик для inline-кнопок (этап оплаты)
3. `science_name_back()` - возврат к выбору типа работы
4. `page_number_back()` - возврат к вводу дисциплины
5. `work_theme_back()` - возврат к вводу количества страниц
6. `custom_plan_back()` - возврат к вводу темы
7. `preferences_back()` - возврат к выбору типа плана

### Логирование:
Каждое нажатие "Назад" логируется:
```python
logging.info(f"Пользователь нажал 'Назад' на шаге: {current_step}")
logging.info("Возврат к ...")
```

## ✅ Преимущества новой системы

✔️ **Гибкость** - можно исправить ошибки на любом этапе  
✔️ **Удобство** - не нужно начинать заново при ошибке  
✔️ **Прозрачность** - логирование всех действий  
✔️ **Безопасность** - корректный сброс данных  
✔️ **UX** - интуитивно понятная навигация
