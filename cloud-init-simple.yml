#cloud-config
package_update: true
package_upgrade: true

packages:
  - python3
  - python3-pip
  - python3-venv
  - git
  - nginx
  - fail2ban
  - htop
  - curl
  - sqlite3

users: []

write_files:
  - path: /etc/systemd/system/ninjaessayai-bot.service
    content: |
      [Unit]
      Description=NinjaEssayAI Telegram Bot
      After=network.target

      [Service]
      Type=simple
      User=root
      WorkingDirectory=/opt/ninjaessayai_bot
      ExecStart=/opt/ninjaessayai_bot/venv/bin/python bot.py
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target
    owner: root:root
    permissions: '0644'

  - path: /opt/setup-bot.sh
    content: |
      #!/bin/bash
      set -e
      
      echo "ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° NinjaEssayAI Bot"
      
      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
      mkdir -p /opt/ninjaessayai_bot
      cd /opt/ninjaessayai_bot
      
      # ÐšÐ»Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      git clone https://github.com/Dmitry140340/NinjaEssayAI.git .
      
      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
      python3 -m venv venv
      source venv/bin/activate
      pip install --upgrade pip
      pip install -r requirements.txt
      
      # Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð°
      cat > .env << 'EOF'
      TELEGRAM_BOT_TOKEN=YOUR_BOT_TOKEN_HERE
      DEEPSEEK_API_KEY=YOUR_DEEPSEEK_API_KEY_HERE
      YOOKASSA_SHOP_ID=YOUR_SHOP_ID_HERE
      YOOKASSA_SECRET_KEY=YOUR_SECRET_KEY_HERE
      EOF
      
      echo "âœ… ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
      echo "âš ï¸  ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ /opt/ninjaessayai_bot/.env"
      echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº: systemctl start ninjaessayai-bot"
    owner: root:root
    permissions: '0755'

runcmd:
  - /opt/setup-bot.sh
  - systemctl daemon-reload
  - systemctl enable ninjaessayai-bot
  - ufw --force enable
  - ufw allow ssh
  - ufw allow http

final_message: |
  âœ… Ð¡ÐµÑ€Ð²ÐµÑ€ Ð³Ð¾Ñ‚Ð¾Ð²!
  
  Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:
  1. ÐžÑ‚Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ: nano /opt/ninjaessayai_bot/.env
  2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ: systemctl start ninjaessayai-bot
  3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ: systemctl status ninjaessayai-bot
